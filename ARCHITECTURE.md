# 系统架构文档

## 架构概览

AWS CDN 管理平台采用前后端分离的微服务架构，使用 Docker 容器化部署。

```
┌─────────────┐
│   用户浏览器  │
└──────┬───────┘
       │
       ▼
┌─────────────┐
│  Nginx      │  (反向代理)
└──────┬──────┘
       │
       ├──────────────┐
       │              │
       ▼              ▼
┌─────────────┐  ┌─────────────┐
│  Vue.js     │  │  Golang API │
│  Frontend   │  │  Backend    │
└─────────────┘  └──────┬───────┘
                        │
                        ├──────────────┐
                        │              │
                        ▼              ▼
                 ┌─────────────┐  ┌─────────────┐
                 │ PostgreSQL  │  │  AWS Services│
                 │  Database   │  │  (Route53,   │
                 └─────────────┘  │   ACM, CF)   │
                                 └─────────────┘
```

## 组件说明

### 前端 (Vue.js)

- **技术栈**: Vue 3 + Vite + Element Plus
- **功能**: 
  - 域名管理界面
  - 重定向管理界面
  - API 调用和状态管理
- **部署**: Nginx 容器，静态文件服务

### 后端 (Golang)

- **技术栈**: Gin + GORM + AWS SDK
- **功能**:
  - RESTful API
  - 业务逻辑处理
  - AWS 服务集成
- **部署**: Docker 容器

### 数据库 (PostgreSQL)

- **用途**: 存储域名、重定向规则等数据
- **部署**: Docker 容器或外部数据库

### AWS 服务集成

#### Route53
- 创建和管理托管区域
- 获取 NS 服务器配置

#### ACM (Certificate Manager)
- 请求 SSL/TLS 证书
- 证书状态查询

#### CloudFront
- 创建和管理 CDN 分发
- 域名绑定

#### S3
- 存储静态资源
- CloudFront 源站

## 数据流

### 域名转入流程

```
1. 用户提交域名转入请求
   ↓
2. 后端创建 Route53 托管区域
   ↓
3. 返回 NS 服务器配置
   ↓
4. 用户在原注册商更新 NS 服务器
   ↓
5. 后端异步请求 ACM 证书
   ↓
6. 等待 DNS 验证
   ↓
7. 证书签发，更新状态
```

### 重定向流程

```
1. 用户访问源域名
   ↓
2. 请求到达 CloudFront
   ↓
3. CloudFront 转发到后端 API
   ↓
4. 后端根据轮询算法选择目标 URL
   ↓
5. 设置缓存头
   ↓
6. 返回重定向响应
   ↓
7. 浏览器缓存结果并重定向
```

## 轮询算法

当前实现使用基于客户端 IP 和时间的哈希算法：

```go
hash = hash(clientIP) + hash(currentMinute)
targetIndex = hash % len(targets)
```

**改进建议**:
- 使用浏览器 localStorage 记录访问次数
- 实现更精确的轮询（基于访问次数而非哈希）
- 支持权重配置

## 安全架构

### 认证和授权
- JWT Token 认证（待实现）
- 基于角色的访问控制（待实现）

### 数据安全
- 数据库连接加密（SSL）
- 敏感信息加密存储
- API 请求加密（HTTPS）

### 网络安全
- 防火墙规则
- VPC 隔离（AWS 部署）
- 安全组配置

## 扩展性

### 水平扩展
- 后端服务可多实例部署
- 使用负载均衡器分发请求
- 数据库读写分离

### 垂直扩展
- 增加服务器资源
- 优化数据库配置
- 缓存层（Redis）

## 监控和日志

### 应用监控
- 健康检查端点
- 性能指标收集
- 错误追踪

### 日志管理
- 结构化日志
- 日志聚合（ELK Stack）
- 日志保留策略

## 高可用性

### 数据库
- 主从复制
- 自动故障转移
- 定期备份

### 应用服务
- 多实例部署
- 健康检查
- 自动重启

### AWS 服务
- 多区域部署
- 自动故障转移
- 监控告警

## 性能优化

### 前端优化
- 代码分割
- 资源压缩
- CDN 加速
- 浏览器缓存

### 后端优化
- 数据库索引
- 查询优化
- 连接池
- 缓存策略

### 基础设施优化
- 负载均衡
- 自动扩缩容
- 资源监控


